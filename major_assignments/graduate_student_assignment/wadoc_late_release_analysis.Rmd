---
title: "WA DOC Late Release Analysis"
author: "Paul Kiefer"
date: "2023-12-01"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Loading libraries:

```{r cars}
options(scipen=999)
#install.packages("ggrepel")
#install.packages('ggthemes')
library(tidyverse)
library(tidyr)
library(lubridate)
library(janitor)
library(ggthemes)
library(tidycensus)
library(ggplot2)
library(ggrepel)
library(tigris)
library(sf)
library(tibble)
```


Answering the basics:

1. Who created and maintains the data? What state program or law is connected to it?

The Washington Department of Corrections collects and maintains data on facility populations and total releases by destination county/state as part of its annual budgetary and staffing assessments. The DOC must adequately staff both its facilities and its probation/parole offices, and those datapoints are necessary to ensure staffing meets demand.

I obtained the late release dataset via FOIA request in September 2023. I have requested similar datasets in the past, but all previous versions have been too messy to salvage. The DOC keeps a central database of inmates currently and previously in its custody , in part to produce annual recidivism reports required by state law. It also keeps track of inmates' ERDs, which are important deadlines for arranging reentry plans. 

If this data contains aggregates (totals), can you find itemized data that those totals are derived from? Do the totals match your own calculations using the itemized data?

The population by facility/program dataset includes aggregate figures for all prisons, all full-custody facilities, and all full- and partial-custody facilities. I can calculate the sum of all estimated facility populations and compare those to the DOC's aggregate figures to fact-check their datasets; I do so below.

## Reading in datasets/dataset descriptions:

I read in my core dataset: A spreadsheet of every Washington DOC inmate released more than two weeks after their earned release date (ERD) from January 2021 to August 2023.

It contains seven columns:

docnum: The unique ID number of an inmate released 2+ weeks after their ERD. I convert this to a character type.
admitdate: The date an inmate entered DOC custody. I convert this to a date type.
facility_released_from: The facility/unit from which an inmate was released. Facilities may have multiple units (ex. MCC TRU and MCC IMU, both at the Monroe Correctional Complex). This column also includes work release facilities, juvenile detention facilities, and some community-based partial custody programs, as well as an interstate compact program. This does not represent the facility in which that person spent most of their time in custody; a person may be sent to a new prison/work release facility shortly before release.
released_to_county_or_state: The Washington county or state to which an inmate was released. This field also includes non-county/-state values, including immigration authorities and US marshals. 
erd: An inmate's Earned Release Date, calculated based on an inmate's "good time credits" (earned through employment, coursework, certification programs, "good behavior", etc.). Preparations for release, including post-release housing plans, generally rely on an ERD as a start date.
release_date: The date on which an inmate was released from custody. This dataset only includes releases from January 2022 to August 2023.
rel_past_erd_days: The number of days a person spent in custody after their ERD. This dataset only includes inmates who spent 2+ weeks in custody after their ERD, so the lowest possible value in this column is 14.


```{r}
wadoc_late_release <- read_csv("data/wadoc_late_release.csv", guess_max = 1683) |>
  clean_names() |>
  ## make the release_date, erd and admitdate columns into mdy date formats and the docnum column into a character column.
  mutate(admitdate = mdy(admitdate),
         erd = mdy(erd),
         release_date = mdy(release_date),
         docnum = as.character(docnum))
```
```{r}
# Confirm the data type changes worked.
glimpse(wadoc_late_release)
```
After a few hours of tabula-wrangling, I also managed to put together a .csv-format dataset of average populations for every Washington DOC facility (with work release/rented in-state beds lumped toether) for each month from July 2012 to June 2022. I use the select function to avoid reading in 100+ blank columns in the original .csv file. 

This dataset contains 18 columns. 

The first column, "count_year", contains two types of values:

Values that begin with "adp" (ex. adp_jul_2012) represent the average daily population over the course of a month. 
Values that begin with "capacity" (ex. capacity_jul_2012) represent the number of available beds over the course of a month.

The next nine columns represent Washington DOC facilities (ex. washington_state_penitentiary).

The "statewide_emergency_beds" column represents emergency bed capacity/the number of occupied emergency beds, depending on the row.

The "prison_facility_total_statewide_emergency_beds_prison_total_confinement" column represents the total number of regular beds + emergency beds/total number of occupied regular beds/emergency beds in full-custody facilities (prisons). 

The "work_release" column represents the aggregate bed/occupied bed counts for all work release facilities in Washington. 

The "total_and_partial_confinement_totals" column represents the total number of full-custody beds, emergency beds, work release beds and other partial custody beds (inc. beds for a community parenting partial confinement program)/the number of occupied full-custody beds, emergency beds, work release beds and other partial custody beds.

```{r}
wadoc_average_prison_pop <- read_csv("data/wadoc_prison_pop_monthly.csv") |>
  clean_names() |>
  select(count_year, airway_heights_corrections_center, cedar_creek_corrections_center, clallam_bay_corrections_center, coyote_ridge_corrections_center, larch_corrections_center, mission_creek_corrections_center_for_women, monroe_correctional_complex, olympic_corrections_center, stafford_creek_corrections_center, washington_correction_center, washington_correction_center_for_women, washington_state_penitentiary, prison_facility_totals, statewide_emergency_beds, prison_facility_totals_statewide_emergency_beds_prison_total_confinement, work_release, total_and_partial_confinement_totals)
    
```
```{r}
glimpse(wadoc_average_prison_pop)
```
The last dataset contains admission and release data for WA DOC facilities from FY 2006 to FY 2023. 

This dataset includes 37 columns. 

The "county" column contains the full names of all counties in Washington. It also includes non-county values, including an aggregate "Out of State" value for all out-of-state releases and "US Marshals" for releases to the custody of US Marshals.

The remaining columns represent either admissions to DOC custody or releases from DOC custody by fiscal year. For our purposes, only the release-related columns are relevant.

```{r}
wadoc_release_admission <- read_csv("data/wadoc_release_admission.csv") |>
  clean_names()
```

I need a transposed version of the release dataset in order to join with other WA DOC datasets. With mismatched datatypes and both row and column headers, the pivot_long function wasn't a good fit for this task, though the code below isn't as concise as I would like it to be. 

```{r}
#Transpose the dataframe, making sure to explicitly keep it a dataframe. Because it contains multiple data types, the transpose function creates a matrix if I don't specify that I want a dataframe. 

wadoc_release_admission_transposed <- data.frame(t(wadoc_release_admission))

# I set the first row of the wadoc_release_admission_transposed as the column names. 
colnames(wadoc_release_admission_transposed) <- wadoc_release_admission_transposed[1, ]

# I remove the first row to avoid duplication.
wadoc_release_admission_transposed <- wadoc_release_admission_transposed[-1, ]

# I make the row headers into a column.
wadoc_release_admission_transposed <- rownames_to_column(wadoc_release_admission_transposed, var = "fiscal_year")

#I clean the column names.
wadoc_release_admission_transposed <- clean_names(wadoc_release_admission_transposed)
```

## Initial summary statistics: 

As a first step in exploring my late release dataset, I calculate the minimum, maximum, median, mean and quartile range of the "rel_past_erd_days" variable.

```{r}
summary_late_release <- summary(wadoc_late_release$rel_past_erd_days)

summary_late_release
```
There are clearly outliers in the dataset -- namely a person who spent an additional 36 years in custody beyond their ERD. 

With that in mind, I give more weight to the median number of days spent in custody beyond inmates' ERD. Unfortunately, this statistic excludes the unknown number of inmates released fewer than two weeks after their ERD.

I can also make a histogram using the "rel_past_erd_days" column to visualize the distribution of my dataset.

```{r}
ggplot(wadoc_late_release, aes(x = rel_past_erd_days)) +
  geom_histogram(binwidth = 40, fill = "black", color = "blue", alpha = 3) +
  labs(title = "Histogram of rel_past_erd_days",
       x = "rel_past_erd_days",
       y = "Frequency")
```
As the histogram illustrates, the "rel_past_erd_days" column is right-skewed. It follows a poisson distribution.


To continue my initial exploration, I separate the first three quartiles of the dataset (measured using the rel_past_erd_days variable) from the fourth quartile of the dataset.


I isolate the outliers -- inmates who spent at least 93.5 additional days in custody beyond their ERD -- into a new dataset.

```{r}
wadoc_above_3q_releases <- wadoc_late_release |>
  filter(rel_past_erd_days > 93.5)

wadoc_above_3q_releases
```
What were the most common final stops for the 421 inmates released 93+ days after their ERD?

```{r}
wadoc_above_3q_releases|>
  group_by(facility_released_from)|>
  summarize(count_extra_late = n()) |>
  # Calculate percentage of total inmates held 93+ days after their ERD released from each facility/unit/program.
  mutate(pct_of_total = (count_extra_late/sum(count_extra_late)*100)) |>
  arrange(desc(pct_of_total))
```
The largest share of inmates released from custody 93+ days after their ERD spent their final days in custody at the Washington Corrections Center.



I also make a dataset of inmates who spent fewer than 93.5 days in custody after their ERD (i.e. the first three quartiles).

```{r}
wadoc_below_3q_releases <- wadoc_late_release |>
  filter(rel_past_erd_days < 93.5)

wadoc_below_3q_releases
```

I then group the sub-3rd quartile dataset by facility to get a more accurate sense of the mean number of days inmates spent in custody beyond their ERD at each facility.

```{r}
wadoc_below_3q_releases|>
  group_by(facility_released_from)|>
  summarize(mean_late_release = mean(rel_past_erd_days)) |>
  arrange(desc(mean_late_release))
```
I see two notable takeaways from this chart: 

1. Inmates released after their ERD after taking part in Community Parenting Alternative program -- a partial confinement program that allows parents to live in their communities under electronic monitoring surveillance -- spent more time in custody past their ERD on average than inmates in any full custody facility.

2. Three "violator facilities" -- county jails in which the DOC rents beds -- appear in the top ten.



I also calculate the percentage of <93-day late releases from each facility/unit/program.

```{r}
wadoc_below_3q_releases|>
  group_by(facility_released_from)|>
  summarize(count_late = n()) |>
  # Calculate percentage of total inmates held <93 days after their ERD released from each facility/unit/program.
  mutate(pct_of_total = (count_late/sum(count_late)*100)) |>
  arrange(desc(pct_of_total))
```

While unit-specific information is helpful -- among other things, it tells me where to direct outreach to find inmates held in custody beyond their ERD -- I would like to continue my analysis using a dataset with standardized facility names that match the facility/program categories in the other two datasets.

For the sake of simplicity, I'll do this in OpenRefine using the original late release .csv file. I made the the following changes:

1. I created a new column for standardized release facility names.
2. Using the facility names/column names in the monthly prison population dataset, I turned all abbreviated prison names -- including the abbreviated names of units, like the MCC IMU -- into the lowercase full name of the prison.
3. I assigned all work release facilities the value "work_release."
4. I assigned all "violator facilities" and other county-level facilities the value "county_jail".
5. I assigned all juvenile detention facilities or community transition facilities the value "juvenile_detention."
6. I assigned programs like graduated reentry (GRE) and CPA the value "other_partial_confinement."
7. I assigned the interstate compact inmates the value "interstate_compact_inmates."

I'll now read in that standardized dataset.

```{r}
wadoc_late_release_standardized <- read_csv("data/wadoc_late_release_facility_standardized.csv") |>
  clean_names() |>
  mutate(admitdate = mdy(admitdate),
         erd = mdy(erd),
         release_date = mdy(release_date),
         docnum = as.character(docnum))
```

Now that I have standardized the names of facilities, I can the total number of inmates released after their ERD from all units in each facility/from all work release facilities/from all non-work release partial custody programs. 

```{r}
wadoc_late_release_standardized |>
  group_by(facility_released_from_standardized) |>
  summarize(late_release_count = n()) |>
  mutate(pct_of_late_release = (late_release_count/sum(late_release_count)*100)) |>
  arrange(desc(pct_of_late_release))
```
Does the ranking change when I separate the outliers from the first three quartiles?

```{r}
wadoc_standardized_above_3q_releases <- wadoc_late_release_standardized |>
  filter(rel_past_erd_days > 93.5) |>
  group_by(facility_released_from_standardized)|>
  summarize(count_extra_late_release = n()) |>
  mutate(pct_of_extra_late_release = (count_extra_late_release/sum(count_extra_late_release)*100))|>
  arrange(desc(pct_of_extra_late_release))

wadoc_standardized_above_3q_releases
```
Inmates released from county jails are overrepresented among outliers.

## Comparing late releases distribution to WA DOC population distribution.

How do these rankings stack up against the percentage of the entire WA DOC inmate population held at each facility?

First, I need to check that the DOC's calculations of total full custody and total full + partial custody populations are accurate. I will also add a column to count any non-work release partial custody facilities not listed explicitly in the dataset; programs like CPA fall into that category.

```{r}
wadoc_average_prison_pop <- wadoc_average_prison_pop |>
  mutate(confirm_prison_facility_totals = airway_heights_corrections_center + cedar_creek_corrections_center + clallam_bay_corrections_center + coyote_ridge_corrections_center + larch_corrections_center + mission_creek_corrections_center_for_women + monroe_correctional_complex + olympic_corrections_center + stafford_creek_corrections_center + washington_correction_center + washington_correction_center_for_women + washington_state_penitentiary)

wadoc_average_prison_pop <- wadoc_average_prison_pop |>
        mutate(doc_count_vs_confirm = confirm_prison_facility_totals - prison_facility_totals,        
               other_partial_confinement = total_and_partial_confinement_totals - (prison_facility_totals_statewide_emergency_beds_prison_total_confinement + work_release))
```

After May 2014, the prison_facility_total appears to be an accurate sum the population of all full custody facilities. There are some minor discrepancies from 2012 through May 2014 (and, for better or for worse, I did hand-check to make sure the errors were on the part of the DOC), but they appear to have resolved those challenges. It also appears that the DOC significantly ramped up its use of non-work release partial detention between May 2014 and March 2020, with numbers petering out as the pandemic took hold. 

I then need to filter the inmate population dataset to isolate the average daily populations for each facility in months covered by the late release dataset and the monthly population dataset (January 2022-June 2022). Unfortunately, that means leaving out more than half of the months covered by the late release dataset, but it's all I have to work with.

```{r}
wadoc_avg_pop_jan22_jun22 <- wadoc_average_prison_pop |>
  filter(count_year == "adp_jan_2022" | count_year == "adp_feb_2022" | count_year == "adp_mar_2022" | count_year == "adp_apr_2022" | count_year == "adp_may_2022" | count_year == "adp_jun_2022") |>
  rename(month = count_year) 

```

To more easily calculate mean populations for each facility over that timeframe, I need to transpose the average population January 2022-June 2022.

```{r}
wadoc_avg_pop_jan22_jun22_transposed <- data.frame(t(wadoc_avg_pop_jan22_jun22))

# I set the first row of the dataset as the column names. 
colnames(wadoc_avg_pop_jan22_jun22_transposed) <- wadoc_avg_pop_jan22_jun22_transposed[1, ]

# I remove the first row to avoid duplication.
wadoc_avg_pop_jan22_jun22_transposed <- wadoc_avg_pop_jan22_jun22_transposed[-1, ]

# I make the row headers into a column.
wadoc_avg_pop_jan22_jun22_transposed <- rownames_to_column(wadoc_avg_pop_jan22_jun22_transposed, var = "fiscal_year")

#I clean the column names.
wadoc_avg_pop_jan22_jun22_transposed <- clean_names(wadoc_avg_pop_jan22_jun22_transposed)

# Rename the first column and change the monthly population columns to the numeric columns. 

wadoc_avg_pop_jan22_jun22_transposed <- wadoc_avg_pop_jan22_jun22_transposed |>
  rename(facility_released_from_standardized = fiscal_year) |>
  filter(facility_released_from_standardized != "prison_facility_totals" & facility_released_from_standardized != "prison_facility_totals_statewide_emergency_beds_prison_totals" & facility_released_from_standardized != 	"statewide_emergency_beds" & facility_released_from_standardized != "	
total_and_partial_confinement_totals" & facility_released_from_standardized != "confirm_prison_facility_totals" & facility_released_from_standardized != "doc_count_vs_confirm" & facility_released_from_standardized != "prison_facility_totals_statewide_emergency_beds_prison_total_confinement" & facility_released_from_standardized != "total_and_partial_confinement_totals") |>
  mutate(adp_jan_2022 = as.numeric(adp_jan_2022),
         adp_feb_2022 = as.numeric(adp_feb_2022),
         adp_mar_2022 = as.numeric(adp_mar_2022),
         adp_apr_2022 = as.numeric(adp_apr_2022),
         adp_may_2022 = as.numeric(adp_may_2022),
         adp_jun_2022 = as.numeric(adp_jun_2022))

# Just in case I want that transposed dataset later.
wadoc_avg_pop_jan22_jun22_transposed_ranking <- wadoc_avg_pop_jan22_jun22_transposed |>
  mutate(mean_pop_jan22_jun22 = (adp_jan_2022 + adp_feb_2022 + adp_mar_2022 + adp_apr_2022 + adp_may_2022 + adp_jun_2022)/6,
         pct_of_mean_pop = mean_pop_jan22_jun22/sum(mean_pop_jan22_jun22)*100) |>
  #Just to make comparison easier.
  select(facility_released_from_standardized, mean_pop_jan22_jun22, pct_of_mean_pop) |>
  arrange(desc(pct_of_mean_pop))
           
  
wadoc_avg_pop_jan22_jun22_transposed_ranking
```

The late release dataset contains rows for facilities/programs that aren't included in the facility/program population dataset. To make sure this is an apples-to-apples comparison, I need to re-calculate the percentages of late releases from each facility and exclude the rows not included in the facility/program population dataset.

```{r}
wadoc_late_release_standardized |>
  filter(facility_released_from_standardized != "county_jail" | facility_released_from_standardized != "juvenile_detention" | facility_released_from_standardized != "other_partial_confinement") |>
  group_by(facility_released_from_standardized) |>
  summarize(late_release_count = n()) |>
  mutate(pct_of_late_release = (late_release_count/sum(late_release_count)*100)) |>
  arrange(desc(pct_of_late_release))
```

This is an imperfect comparison because of possible changes in the number of people held in each facility/program from June 2022 to August 2023. 

If the populations have remained fairly steady, however, the comparison could also indicate that:

1. Late releases were disproportionately common for inmates held at the Washington Correction Center (by a factor of ~2.8), at least from January 2022 to August 2023. The same can be said for Coyote Ridge Correctional Center, albeit to a lesser extent

2. Inmates at Washington State Penitentiary and Stafford Creek Corrections Center were underrepresented among those released two or more weeks after their ERD. 



## County-level comparisons:

I can also group late releases by the counties/states to which the inmates were released. While it seems reasonable to assume that decisions by DOC administrators may have some role in late releases, a person may also not be released on time because they couldn't identify a release address deemed suitable by their release counselor. That could be because of a shortage of affordable housing options/housing providers willing to accept people with criminal convictions or because a counselor objects to housing options on the grounds that they are too close to hubs of drug activity, among other reasons. If late releases are disproportionately common for inmates released to particular counties, that could point me towards contributing factors outside of the control of the DOC. 

As a basic first step in the county-level analysis, I group the late release dataset by the release county/state.

```{r}
wadoc_late_release_standardized |>
  group_by(released_to_county_or_state) |>
  summarize(late_release_count = n()) |>
  arrange(desc(late_release_count))
```
Unsuprisingly, the most populous counties appear at the top of the list. 

Spokane County is slightly over-represented, as are Yakima and Benton Counties. Gray's Harbor County is by far the most over-represented. I will do this analysis more formally using US Census data, but I first need to compare the number of late releases to the number of total releases by county.

The release/admission dataset counts releases and admissions per county by fiscal year. The late release dataset doesn't neatly map onto the Washington DOC's fiscal year calendar (which end in June), but it does include data from the entirety of FY 2023 (July 2022-June 2023), so I can at least compare late releases by county to total releases by county over one fiscal year.

Here is the 2023 fiscal year:

```{r}
wadoc_late_release_fy23 <- wadoc_late_release |>
  filter(release_date >= as.Date("2022-07-01") & release_date <= as.Date("2023-06-30")) |>
  group_by(released_to_county_or_state) |>
  summarize(late_release_count = n()) |>
  arrange(desc(late_release_count))
           

wadoc_late_release_fy23
```

I also need to write code to replace any state abbreviations with "OUT OF STATE" and merge the "OUT OF STATE" rows into one. 

```{r}

# Replace all of the state abbreviations with "OUT OF STATE" to match the DOC release/admission dataset. 

wadoc_late_release_fy23 <- wadoc_late_release_fy23 |>
  mutate(released_to_county_or_state = if_else(
    released_to_county_or_state %in% c("OR", "ID", "CA", "NV", "OK", "AZ", "CO", "HI", "IN", "MN", "NJ", "OH"),
    "OUT OF STATE",
    released_to_county_or_state 
  )) 

# Use group_by and summarize to combine the "OUT OF STATE" rows.

wadoc_late_release_fy23_grouped <- wadoc_late_release_fy23 |>
  group_by(released_to_county_or_state) |>
  summarize(total_late_release = sum(late_release_count)) |>
  arrange(desc(total_late_release))

# Convert released_to_county_or_state to title case.

wadoc_late_release_fy23_grouped$released_to_county_or_state <- str_to_title(wadoc_late_release_fy23_grouped$released_to_county_or_state)

wadoc_late_release_fy23_grouped
```

I also need to subset the release/admission dataset to single out releases for FY 2023 alone.

```{r}
#Subset for releases in FY 2022:
wadoc_fy23_releases <- wadoc_release_admission |>
  select(county, release_fy23) |>
  mutate(county = str_to_title(county))

wadoc_fy23_releases
```

I now use a left join to match late release numbers to total release numbers and calculate the percentage of all releases to each county that were two or more weeks past the released inmate's ERD.

```{r}
wadoc_all_release_late_release_fy23 <- left_join(wadoc_fy23_releases, wadoc_late_release_fy23_grouped, by=c("county" = "released_to_county_or_state")) |>
  # I want to get rid of the "Total" row for now, so I'll filter it out. I can recalculate it again by calculating the sum of the  
  filter(county != "Total") |>
  # I replace null values in the total_late_release column with 0. 
  mutate(total_late_release = ifelse(is.na(total_late_release), 0, total_late_release)) |>
  # I calculate the percentage of all releases that were two weeks or more past an inmate's ERD.
  mutate(late_release_pct = (total_late_release/release_fy23)*100) |>
  arrange(desc(late_release_pct)) 


wadoc_all_release_late_release_fy23

```

For good measure, I should also calculate the percentage of all releases statewide that were two or more weeks past the released inmate's ERD.

```{r}
total_release_fy23 = (sum(wadoc_all_release_late_release_fy23$total_late_release)/sum(wadoc_all_release_late_release_fy23$release_fy23)) * 100

total_release_fy23
```

20 percent of all people released from Washington DOC custody in FY 2023 were released more than two weeks after their earned release date.  


Now that we have a corresponding percentage for each county, we can make a map.

As a starting point, I need a dataset with the geometry for each Washington county.

```{r}
wa_counties <- counties () |>
  filter(STATEFP == "53")
```

I can now join the late release by county dataframe to my Washington counties dataframe. This step filters out non-county rows in the release dataframe, including releases to immigration authorities.

```{r}
wa_late_release_county <- wa_counties |> left_join(wadoc_all_release_late_release_fy23, join_by(NAME==county))
  
## I want this as a dataframe, not a simple feature object. 
wa_late_release_county <- as.data.frame(wa_late_release_county) 

head(wa_late_release_county)
```
Now I have the geometry I need to make a basic map of late release ratios by county.

```{r}
county_centroids <- st_centroid(wa_counties)
county_centroids_df <- as.data.frame(st_coordinates(county_centroids))
county_centroids_df$NAME <- county_centroids$NAME

ggplot() +
  geom_sf(data=wa_late_release_county, aes(fill=late_release_pct, geometry = geometry)) +
  geom_text(aes(x = X, y = Y, label = NAME), data = county_centroids_df, size = 3, check_overlap = TRUE) +
  scale_colour_viridis_b(option="magma")+
  theme_minimal()
```
Why were three of the four inmates from Whitman County -- a rural county that includes Washington State University -- released more than two weeks after their ERD in 2023? 

If I had admission/release data for each DOC facility, I might be able to identify possible sources of the problem more easily.



How does that map compare to prison releases per capita (late or otherwise) in FY 2023 for each county?

For that calculation, I need my wa_late_release_county dataset, ACS data and my Washington counties dataset.

I start with dataframe of Washington county populations; the latest data available is from the 2021 ACS.

```{r}
wa_county_population <- get_acs(geography = "county",
              variables = c(population = "B01001_001"),
              year = 2021,
              state = "WA") |> rename(county_pop = estimate)
```

I can now join the county population dataset and the release/geometry dataset by GEOID and calculate releases per 1,000 residents in each county.

```{r}
wa_all_release_county_pop <- wa_county_population |> left_join(wa_late_release_county, join_by(GEOID)) |>
  mutate(release_pc = (release_fy23/county_pop)*1000)

head(wa_all_release_county_pop)
```


I make a map with identical formatting for comparison.

```{r}
county_centroids <- st_centroid(wa_counties)
county_centroids_df <- as.data.frame(st_coordinates(county_centroids))
county_centroids_df$NAME <- county_centroids$NAME

ggplot() +
  geom_sf(data=wa_all_release_county_pop, aes(fill=release_pc, geometry = geometry)) +
  geom_text(aes(x = X, y = Y, label = NAME), data = county_centroids_df, size = 3, check_overlap = TRUE) +
  scale_colour_viridis_b(option="magma")+
  theme_minimal()
```
A comparison of the two maps underscores that while 75 percent of inmates released to Whitman County in FY 2023 were released more than two weeks after their ERD, only four people were released from DOC custody to Whitman County in FY 2023 -- among the lowest numbers of releases per capita in the state in the last fiscal year. 

Is there any correlation between releases per capita and the percentage of all releases two weeks or more past released inmates' ERD?

```{r}
correlation_late_release_pct_releases_pc <- cor(wa_all_release_county_pop$late_release_pct, 
                   wa_all_release_county_pop$release_pc)

correlation_late_release_pct_releases_pc
```
There is a very weak negative correlation, meaning counties with higher numbers of releases per capita are marginally less likely to be the release county for inmates held two or more weeks past their ERD.

I can also represent this as a scatterplot. 

```{r}
ggplot(wa_all_release_county_pop, aes(x = late_release_pct, y = release_pc, label = NAME.y)) +
  geom_point() +
  geom_text_repel(box.padding = 0.2) +  # Adjust box.padding as needed for label positioning
  labs(title = "Weak negative correlation between DOC releases per capita and late release ratio",
       x = "Late release ratio",
       y = "Releases per 1,000 residents")
```
With only a handful of datapoints for Lincoln and Whitman counties, I am not inclined to treat them as statistically significant. I'm more curious whether the relatively similar late release ratios for Washington's larger counties -- both wealthy and poor -- means that late releases are purely a result of DOC administration. Are there any on-the-ground conditions in wealthy counties/poor counties that contribute to late releases, and are those conditions different?

## Correlation between median rent and late releases as a percentage of total releases.

Is there any correlation between median rent on a county level and the ratio of late releases to total releases in that county between January 2022 and August 2023? Does median rent data provide a viable stand-in to assess whether housing scarcity impacts whether a person is released from custody on time?

I first need to load my ACS variables. 

```{r}
#Load ACS5 variables
acs5 <- load_variables(2021, "acs5", cache = TRUE)

acs5
```
I can then create a dataset for median rents by Washington county in 2021.

```{r}
wa_county_median_rent <- get_acs(geography = "county",
              variables = c(median_rent = "B25113_001"),
              state = "WA",
              year = 2021,
              geometry = TRUE)
```
I then join the median rent dataset with my existing dataset of Washington counties with geometry and late releases as a percentage of all releases using GEOID.

```{r}
wa_release_county_pop_rent <- wa_all_release_county_pop |> left_join(wa_county_median_rent, join_by(GEOID)) |>
  rename(median_rent = estimate)

wa_release_county_pop_rent
```
I calculate the correlation between a county's median rent and the percentage of all people released to that county between January 2022 and August 2023 who spent two or more weeks in custody past their ERD. 

```{r}
correlation_late_release_median_rent <- cor(wa_release_county_pop_rent$late_release_pct, 
                   wa_release_county_pop_rent$median_rent)

correlation_late_release_median_rent
```
There is a weak positive correlation between median rent and the ratio of late releases to total releases by county, meaning that counties with higher median rents have marginally higher ratios of late releases to total releases.

And here is a scatterplot of those datapoints weighted by the number of late releases per county. I clearly need to weight the correlation by the number of releases to get a more accurate assessment of the relationship between late releases and median rent, but I ran into trouble trying to download the R packages needed to run the weighted.cor function.

I imagine that if I weighted by the number of late releases, the correlation would be far more statistically significant.

```{r}
ggplot(wa_release_county_pop_rent, aes(x = late_release_pct, y = median_rent, label = NAME.y, size = total_late_release)) +
  geom_point() +
  geom_text_repel(box.padding = 0.2) +  # Adjust box.padding as needed for label positioning
  labs(title = "Correlation between late releases and median rent on county level",
       x = "Late release ratio",
       y = "Median rent")
```

## Comparing total late releases and late releases per 1,000 inmates at WA DOC facilities/in WA DOC programs.

Moving on to the relationship between the number of people incarcerated in a given WA DOC facility/program and the percentage of releases from that facility/program two weeks or more after the released inmate's ERD:

Because the DOC's facility population dataset ends in June 2022, I have less than a year of overlap between the two datasets.

To make the most of my limited data, I start by subsetting my facility population dataset to isolate the period from January 2022 and June 2022. 

```{r}
wadoc_avg_pop_jan22_jun22 <- wadoc_average_prison_pop |>
  filter(count_year == "adp_jan_2022" | count_year == "adp_feb_2022" | count_year == "adp_mar_2022" | count_year == "adp_apr_2022" | count_year == "adp_may_2022" | count_year == "adp_jun_2022") |>
  rename(month = count_year)
```

I also need to add a month and year filter to the late_release_standardized dataset, isolate January-Jun 2022, and group by facility.

```{r}
wadoc_late_release_standardized_2022 <- wadoc_late_release_standardized |>
  #I keep the months in numeric format for easier filtering.
  mutate(release_month = month(release_date),
         release_year = year(release_date)) |>
  filter(release_year == 2022) |>
  filter(release_month >= 1 & release_month <= 6) |>
  group_by(facility_released_from_standardized, release_month) |>
  summarize(late_release_count = n())

wadoc_late_release_standardized_2022

```

In order to join these datasets, I need to transpose the monthly population dataset and make the values in that month column into numbers. 

```{r}
wadoc_avg_pop_jan22_jun22_transposed <- data.frame(t(wadoc_avg_pop_jan22_jun22))

# I set the first row of the dataset as the column names. 
colnames(wadoc_avg_pop_jan22_jun22_transposed) <- wadoc_avg_pop_jan22_jun22_transposed[1, ]

# I remove the first row to avoid duplication.
wadoc_avg_pop_jan22_jun22_transposed <- wadoc_avg_pop_jan22_jun22_transposed[-1, ]

# I make the row headers into a column.
wadoc_avg_pop_jan22_jun22_transposed <- rownames_to_column(wadoc_avg_pop_jan22_jun22_transposed, var = "fiscal_year")

#I clean the column names.
wadoc_avg_pop_jan22_jun22_transposed <- clean_names(wadoc_avg_pop_jan22_jun22_transposed)

# Rename the first column and change the monthly population columns to the numeric columns. 

wadoc_avg_pop_jan22_jun22_transposed <- wadoc_avg_pop_jan22_jun22_transposed |>
  rename(facility_released_from_standardized = fiscal_year) |>
  mutate(adp_jan_2022 = as.numeric(adp_jan_2022),
         adp_feb_2022 = as.numeric(adp_feb_2022),
         adp_mar_2022 = as.numeric(adp_mar_2022),
         adp_apr_2022 = as.numeric(adp_apr_2022),
         adp_may_2022 = as.numeric(adp_may_2022),
         adp_jun_2022 = as.numeric(adp_jun_2022))

```

I also need to turn the "release_month" values of the wadoc_late_release_standardized_2022 column into columns of their own. I do that with a pivot_wider function.

```{r}
wadoc_late_release_standardized_2022_wide <- pivot_wider(
  data = wadoc_late_release_standardized_2022,
  id_cols = facility_released_from_standardized,
  names_from = release_month,
  values_from = late_release_count
) |>
  # Since the months in the dataset were in numeric format, I use the column index for renaming.
  rename(late_release_jan22 = 2,
         late_release_feb22 = 3,
         late_release_mar22 = 4,
         late_release_apr22 = 5,
         late_release_may22 = 6,
         late_release_jun22 = 7) |>
  # I replace null values with 0. 
   mutate_all(~ ifelse(is.na(.), 0, .))
  
```
Now I can join by facility. This filters out county jails and other facilities for which the Washington DOC doesn't provide average daily pop per month. 

```{r}
wadoc_late_release_facility_pop_2022 <- left_join(wadoc_avg_pop_jan22_jun22_transposed, wadoc_late_release_standardized_2022_wide, by = c("facility_released_from_standardized")) |>
  # I filter out the aggregate figures.
  filter(
    facility_released_from_standardized != "prison_facility_totals" &
    facility_released_from_standardized != "statewide_emergency_beds" &
    facility_released_from_standardized != "prison_facility_totals_statewide_emergency_beds_prison_total_confinement" &
    facility_released_from_standardized != "total_and_partial_confinement_totals" &
    facility_released_from_standardized != "confirm_prison_facility_totals" &
    facility_released_from_standardized != "doc_count_vs_confirm"
  )
```

I can now make dodged bar charts of both total late releases by facility and late releases per 1,000 inmates by facility. I will start with total late releases.

```{r}
wadoc_late_release_facility_total_2022 <- wadoc_late_release_facility_pop_2022 |>
    rename(late_release_total_01_2022 = (late_release_jan22),
           late_release_total_02_2022 = (late_release_feb22),
           late_release_total_03_2022 = (late_release_mar22),
           late_release_total_04_2022 = (late_release_apr22),
           late_release_total_05_2022 = (late_release_may22),
           late_release_total_06_2022 = (late_release_jun22))
```

In order to plot this as a dodged bar chart, I create a new dataframe with only the total late releases and transpose it (again) to turn the facilities into columns once again.

```{r}
wadoc_late_release_facility_total_2022 <- wadoc_late_release_facility_total_2022 |>
  select(facility_released_from_standardized, late_release_total_01_2022, late_release_total_02_2022, late_release_total_03_2022, late_release_total_04_2022, late_release_total_05_2022, late_release_total_06_2022)
```

I then have to turn the transposed data back into a dataframe, adjust and clean row names, and change the data types for facility columns to <dbl>.
```{r}
wadoc_late_release_facility_total_2022_transposed <- data.frame(t(wadoc_late_release_facility_total_2022))

# I set the first row of the dataset as the column names. 
colnames(wadoc_late_release_facility_total_2022_transposed) <- wadoc_late_release_facility_total_2022_transposed[1, ]

# I remove the first row to avoid duplication.
wadoc_late_release_facility_total_2022_transposed <- wadoc_late_release_facility_total_2022_transposed[-1, ]

# I make the row headers into a column.
wadoc_late_release_facility_total_2022_transposed<- rownames_to_column(wadoc_late_release_facility_total_2022_transposed, var = "fiscal_year")

#I clean the column names.
wadoc_late_release_facility_total_2022_transposed <- clean_names(wadoc_late_release_facility_total_2022_transposed)

# Rename the first column and change the facility columns to the numeric columns. 
wadoc_late_release_facility_total_2022_transposed<- wadoc_late_release_facility_total_2022_transposed |>
  rename(month = fiscal_year) |>
  mutate(airway_heights_corrections_center = as.numeric(airway_heights_corrections_center),
         cedar_creek_corrections_center = as.numeric(cedar_creek_corrections_center),
         clallam_bay_corrections_center = as.numeric(clallam_bay_corrections_center),
         coyote_ridge_corrections_center = as.numeric(coyote_ridge_corrections_center),
         larch_corrections_center = as.numeric(larch_corrections_center),
         mission_creek_corrections_center_for_women = as.numeric(mission_creek_corrections_center_for_women),
         monroe_correctional_complex = as.numeric(monroe_correctional_complex),
         olympic_corrections_center = as.numeric(olympic_corrections_center),
         stafford_creek_corrections_center = as.numeric(stafford_creek_corrections_center),
         washington_correction_center = as.numeric(washington_correction_center),
         washington_correction_center_for_women = as.numeric(washington_correction_center_for_women),
         washington_state_penitentiary = as.numeric(washington_state_penitentiary),
         work_release = as.numeric(work_release),
         other_partial_confinement = as.numeric(other_partial_confinement))

```

In order to extract dates from the month column, I need to use the str_replace function to remove the "late_release_total_" string from each value and apply the lubridate month/year function.

```{r}
wadoc_late_release_facility_total_2022_transposed$month <- my(str_replace(wadoc_late_release_facility_total_2022_transposed$month, "late_release_total_", ""))
```

Unfortunately, the resulting bar graph is virtually unreadable, though it does draw attention to the monthly number of late releases from the Washington Correction Center.

```{r}
wadoc_total_long <- gather(wadoc_late_release_facility_total_2022_transposed, key = "facility", value = "value", -month)

ggplot(wadoc_total_long, aes(x = month, y = value, fill = facility)) +
  geom_col(position = "dodge") +
  labs(title = "Total Late Releases by Facility per Month",
       x = "Month",
       y = "Total Late Releases",
       fill = "Facility") +
  scale_fill_manual(values = c("airway_heights_corrections_center" = "lightblue", "cedar_creek_corrections_center" = "red", "clallam_bay_corrections_center" = "darkgreen", "coyote_ridge_corrections_center" = "orange", "larch_corrections_center" = "maroon", "mission_creek_corrections_center_for_women" = "blue", "monroe_correctional_complex" = "yellow", "olympic_corrections_center" = "lightgreen", "stafford_creek_corrections_center" = "purple", "washington_correction_center" = "pink", "washington_correction_center_for_women" = "black", "washington_state_penitentiary" = "magenta", "work_release" = "grey", "other_partial_confinement" = "brown")) +
  theme_minimal()
```
I now begin working on the bar graph of late releases per capita. Again, I would get far more insight by calculating the number of late releases as a percentage of all releases from each facility, but I do not have facility-level release data.


```{r}
wadoc_late_release_facility_pc_2022 <- wadoc_late_release_facility_pop_2022 |>
    mutate(
        late_release_pc_01_2022 = (late_release_jan22 / adp_jan_2022) * 1000,
        late_release_pc_02_2022 = (late_release_feb22 / adp_feb_2022) * 1000,
        late_release_pc_03_2022 = (late_release_mar22 / adp_mar_2022) * 1000,
        late_release_pc_04_2022 = (late_release_apr22 / adp_apr_2022) * 1000,
        late_release_pc_05_2022 = (late_release_may22 / adp_may_2022) * 1000,
        late_release_pc_06_2022 = (late_release_jun22 / adp_jun_2022) * 1000
    )
```


```{r}
wadoc_late_release_facility_pc_2022 <- wadoc_late_release_facility_pc_2022 |>
    select(
        facility_released_from_standardized,
        late_release_pc_01_2022,
        late_release_pc_02_2022,
        late_release_pc_03_2022,
        late_release_pc_04_2022,
        late_release_pc_05_2022,
        late_release_pc_06_2022
    )
```


I then have to turn the transposed data back into a dataframe, adjust and clean row names, and change the data types for facility columns to <dbl>.
```{r}
wadoc_late_release_facility_pc_2022_transposed <- data.frame(t(wadoc_late_release_facility_pc_2022))

# I set the first row of the dataset as the column names. 
colnames(wadoc_late_release_facility_pc_2022_transposed) <- wadoc_late_release_facility_pc_2022_transposed[1, ]

# I remove the first row to avoid duplication.
wadoc_late_release_facility_pc_2022_transposed <- wadoc_late_release_facility_pc_2022_transposed[-1, ]

# I make the row headers into a column.
wadoc_late_release_facility_pc_2022_transposed<- rownames_to_column(wadoc_late_release_facility_pc_2022_transposed, var = "fiscal_year")

#I clean the column names.
wadoc_late_release_facility_pc_2022_transposed <- clean_names(wadoc_late_release_facility_pc_2022_transposed)

# Rename the first column and change the facility columns to the numeric columns. 
wadoc_late_release_facility_pc_2022_transposed<- wadoc_late_release_facility_pc_2022_transposed |>
  rename(month = fiscal_year) |>
  mutate(airway_heights_corrections_center = as.numeric(airway_heights_corrections_center),
         cedar_creek_corrections_center = as.numeric(cedar_creek_corrections_center),
         clallam_bay_corrections_center = as.numeric(clallam_bay_corrections_center),
         coyote_ridge_corrections_center = as.numeric(coyote_ridge_corrections_center),
         larch_corrections_center = as.numeric(larch_corrections_center),
         mission_creek_corrections_center_for_women = as.numeric(mission_creek_corrections_center_for_women),
         monroe_correctional_complex = as.numeric(monroe_correctional_complex),
         olympic_corrections_center = as.numeric(olympic_corrections_center),
         stafford_creek_corrections_center = as.numeric(stafford_creek_corrections_center),
         washington_correction_center = as.numeric(washington_correction_center),
         washington_correction_center_for_women = as.numeric(washington_correction_center_for_women),
         washington_state_penitentiary = as.numeric(washington_state_penitentiary),
         work_release = as.numeric(work_release),
         other_partial_confinement = as.numeric(other_partial_confinement))

```

In order to extract dates from the month column, I need to use the str_replace function to remove the "late_release_pc" string from each value and apply the lubridate month/year function.

```{r}
wadoc_late_release_facility_pc_2022_transposed$month <- my(str_replace(wadoc_late_release_facility_pc_2022_transposed$month, "late_release_pc_", ""))
```

Once again, the resulting bar graph is virtually unreadable, though it does draw attention to the monthly number of late releases per 1,000 inmates at the Washington Correction Center and from the state's work release facilities.

```{r}
wadoc_long <- gather(wadoc_late_release_facility_pc_2022_transposed, key = "facility", value = "value", -month)

ggplot(wadoc_long, aes(x = month, y = value, fill = facility)) +
  geom_col(position = "dodge") +
  labs(title = "Late Releases per 1,000 Inmates by Facility per Month",
       x = "Month",
       y = "Late Releases per 1,000 Inmates",
       fill = "Facility") +
  scale_fill_manual(values = c("airway_heights_corrections_center" = "lightblue", "cedar_creek_corrections_center" = "red", "clallam_bay_corrections_center" = "darkgreen", "coyote_ridge_corrections_center" = "orange", "larch_corrections_center" = "maroon", "mission_creek_corrections_center_for_women" = "blue", "monroe_correctional_complex" = "yellow", "olympic_corrections_center" = "lightgreen", "stafford_creek_corrections_center" = "purple", "washington_correction_center" = "pink", "washington_correction_center_for_women" = "black", "washington_state_penitentiary" = "magenta", "work_release" = "grey", "other_partial_confinement" = "brown")) +
  theme_minimal()
```

## Memo: 

Between January 2022 and August 2023, one-fifth of all people released from Washington DOC custody left prisons or work release facilities two or more weeks after their scheduled release date.

That is the core story of this dataset. The release planning process relies on an Earned Release Date -- a date assigned based on an inmate's "good time credits," which they earn through employment, coursework, certification programs or "good behavior" -- as an anchor. A person preparing for release may, for instance, line up a job; their soon-to-be boss will expect them to show up for work shortly after their ERD. A person preparing for release may apply for a reentry housing voucher; that voucher will become effective on their ERD. A person preparing for release may pay to reserve a bed in a recovery home; that bed will be ready for them on their ERD.If they are released after their ERD, release plans unravel. 

The data does not indicate why such a large portion of Washington DOC inmates released from January 2022 to August 2023 spent weeks in custody past their ERD. 

It does, however, suggest one place to look: The Washington Correction Center in Shelton. Despite making up roughly 12 percent of Washington's total incarcerated population, the WCC was the final stop for more than a third of people released two or more weeks after their ERD from January 2022 to August 2023. 

The data does not indicate how long those people had spent at the WCC, but if they were released from that facility, they were assigned a counselor -- responsible for approving their release plans -- at WCC. Could part of the problem lay in the release planners or administrators at WCC?

Factors outside the control of the WA DOC may also play into the alarming number of late releases. Housing shortages -- both rural and urban -- could be a factor. That said, there is relatively little difference between the rate of late releases (as a percentage of all releases) in a wealthy county like King County and a poor county like Gray's Harbor County. If I could find people released late to each county, could I ascertain how/if barriers to timely release differ between wealthy and poor counties?

My initial calculation of the correlation between median rent and the ratio of late releases to total releases by county indicated a statistically insignificant relationship, but a scatterplot of the same data weighted by the number of late releases to each county suggested that there may be a much stronger correlation that I initially calculated. What role does housing scarcity play in late releases?

Unfortunately, the scope of my comparisons are limited by mismatched timelines, mismatched categories and the absence of data about releases by facility. Calculating the mean populations for each DOC facility/program with data for the first six months of 2022 as a point of comparison for late releases was certainly not ideal.



